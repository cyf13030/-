# app.py
import streamlit as st
import akshare as ak
import pandas as pd
from datetime import datetime, date
import time

# ==================== é…ç½®éƒ¨åˆ† ====================
# ä½ å¯ä»¥åœ¨è¿™é‡Œä¿®æ”¹é»˜è®¤å…³æ³¨çš„åŸºé‡‘ï¼ˆåŸºé‡‘ä»£ç åˆ—è¡¨ï¼‰
DEFAULT_FUNDS = [
    "110022",   # æ˜“æ–¹è¾¾ä¼˜é€‰æˆé•¿æ··åˆ
    "001593",   # å—æ–¹æˆä»½ç²¾é€‰æ··åˆ
    "000001",   # åå¤æˆé•¿æ··åˆ
    "519697",   # é•¿ä¿¡é‡åŒ–å…ˆé”‹è‚¡ç¥¨
    # åœ¨è¿™é‡Œæ·»åŠ ä½ è‡ªå·±çš„åŸºé‡‘ä»£ç ï¼Œä¾‹å¦‚ "161725", "005827" ç­‰
]

# é¡µé¢æ ‡é¢˜å’Œå¸ƒå±€
st.set_page_config(
    page_title="ä¸ªäººåŸºé‡‘ä¼°å€¼å°å·¥å…·",
    page_icon="ğŸ“ˆ",
    layout="wide"
)

# ==================== æ ‡é¢˜å’Œè¯´æ˜ ====================
st.title("ğŸ“Š ä¸ªäººåŸºé‡‘å®æ—¶ä¼°å€¼æŸ¥è¯¢")
st.caption(f"æ•°æ®æ¥æºï¼šä¸œæ–¹è´¢å¯Œç½‘å‡€å€¼ä¼°ç®—ï¼ˆé€šè¿‡ AKShare è·å–ï¼‰ | æ›´æ–°æ—¶é—´ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
st.markdown("""
**ä½¿ç”¨è¯´æ˜**ï¼š
- å·¦ä¾§å¯å¤šé€‰æˆ–æ‰‹åŠ¨è¾“å…¥åŸºé‡‘ä»£ç 
- æ˜¾ç¤ºä¸œæ–¹è´¢å¯Œæä¾›çš„**ä¼°ç®—å‡€å€¼**å’Œ**ä¼°ç®—å¢é•¿ç‡**ï¼ˆé€šå¸¸äº¤æ˜“æ—¥ 9:30 åå¼€å§‹æ›´æ–°ï¼Œ15:00 åè¾ƒå‡†ç¡®ï¼‰
- ä¼°å€¼**ä»…ä¾›ä¸ªäººå‚è€ƒ**ï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®
- å¦‚æœæ•°æ®ä¸ºç©ºï¼šå¯èƒ½æ˜¯æ¥å£å»¶è¿Ÿã€éäº¤æ˜“æ—¥æˆ–ä»£ç é”™è¯¯ï¼Œè¯·ç¨ç­‰æˆ–åˆ·æ–°
""")

# ==================== ä¾§è¾¹æ  - åŸºé‡‘é€‰æ‹© ====================
with st.sidebar:
    st.header("åŸºé‡‘é€‰æ‹©")
    
    # å¤šé€‰é»˜è®¤åŸºé‡‘
    selected_funds = st.multiselect(
        "é€‰æ‹©å…³æ³¨çš„åŸºé‡‘",
        options=DEFAULT_FUNDS + ["å…¶ä»–"],
        default=DEFAULT_FUNDS[:4],  # é»˜è®¤æ˜¾ç¤ºå‰4ä¸ª
        help="å¯å¤šé€‰ï¼ŒæŒ‰ä½ Ctrl æˆ– Cmd é”®"
    )
    
    # æ‰‹åŠ¨è¾“å…¥æ–°åŸºé‡‘
    custom_input = st.text_input(
        "æˆ–æ‰‹åŠ¨è¾“å…¥åŸºé‡‘ä»£ç ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰",
        placeholder="ä¾‹å¦‚ï¼š161725,005827,159941",
        help="æ”¯æŒå¤šä¸ªï¼Œç”¨è‹±æ–‡é€—å·åˆ†éš”"
    )
    
    if custom_input:
        custom_list = [code.strip() for code in custom_input.split(",") if code.strip().isdigit() and len(code.strip()) == 6]
        selected_funds = list(set(selected_funds + custom_list))  # å»é‡
    
    # åˆ·æ–°æŒ‰é’®
    if st.button("ğŸ”„ ç«‹å³åˆ·æ–°æ•°æ®", type="primary"):
        st.session_state["last_refresh"] = time.time()
        st.rerun()

# ==================== ä¸»å†…å®¹åŒº ====================
if not selected_funds:
    st.info("è¯·åœ¨å·¦ä¾§é€‰æ‹©æˆ–è¾“å…¥è‡³å°‘ä¸€ä¸ªåŸºé‡‘ä»£ç ")
else:
    with st.spinner("æ­£åœ¨æ‹‰å–æœ€æ–°ä¼°å€¼æ•°æ®..."):
        try:
            # è·å–ä¸œæ–¹è´¢å¯Œå…¨å¸‚åœºä¼°ç®—å‡€å€¼æ•°æ®
            df = ak.fund_value_estimation_em(symbol="å…¨éƒ¨")
            
            # è¿‡æ»¤å…³æ³¨çš„åŸºé‡‘
            df['åŸºé‡‘ä»£ç '] = df['åŸºé‡‘ä»£ç '].astype(str).str.zfill(6)  # è¡¥é½6ä½
            watched = df[df['åŸºé‡‘ä»£ç '].isin(selected_funds)].copy()
            
            if watched.empty:
                st.warning("æœªæ‰¾åˆ°åŒ¹é…çš„ä¼°å€¼æ•°æ®ï¼Œå¯èƒ½åŸå› ï¼š\n1. éäº¤æ˜“æ—¶é—´\n2. åŸºé‡‘ä»£ç é”™è¯¯\n3. æ¥å£ä»Šæ—¥æš‚æœªæ›´æ–°\nè¯·ç¨åå†è¯•æˆ–æ£€æŸ¥ä»£ç ")
            else:
                # æ•°æ®æ¸…æ´—å’Œæ ¼å¼åŒ–
                watched = watched[[
                    'åŸºé‡‘ä»£ç ', 'åŸºé‡‘åç§°', 
                    'äº¤æ˜“æ—¥-ä¼°ç®—æ•°æ®-ä¼°ç®—å€¼', 
                    'äº¤æ˜“æ—¥-ä¼°ç®—æ•°æ®-ä¼°ç®—å¢é•¿ç‡',
                    'ä¼°ç®—åå·®'
                ]]
                
                # é‡å‘½ååˆ—ï¼ˆæ›´å‹å¥½ï¼‰
                watched.columns = ['ä»£ç ', 'åç§°', 'ä¼°ç®—å‡€å€¼', 'ä¼°ç®—æ¶¨å¹…', 'åå·®']
                
                # è½¬æ¢ä¸ºæ•°å€¼æ–¹ä¾¿æ’åºå’Œå›¾è¡¨
                watched['ä¼°ç®—æ¶¨å¹…(%)'] = watched['ä¼°ç®—æ¶¨å¹…'].str.rstrip('%').replace('', '0').astype(float)
                watched['ä¼°ç®—å‡€å€¼'] = pd.to_numeric(watched['ä¼°ç®—å‡€å€¼'], errors='coerce')
                
                # æ’åºï¼šæ¶¨å¹…é™åº
                watched = watched.sort_values('ä¼°ç®—æ¶¨å¹…(%)', ascending=False).reset_index(drop=True)
                
                # æ˜¾ç¤ºè¡¨æ ¼
                st.subheader(f"ä¼°å€¼å¿«ç…§ï¼ˆ{len(watched)} åªåŸºé‡‘ï¼‰")
                st.dataframe(
                    watched.style.format({
                        'ä¼°ç®—å‡€å€¼': '{:.4f}',
                        'ä¼°ç®—æ¶¨å¹…(%)': '{:+.2f}%',
                        'åå·®': '{:.2f}%'
                    }).background_gradient(
                        subset=['ä¼°ç®—æ¶¨å¹…(%)'],
                        cmap='RdYlGn',
                        vmin=-3, vmax=3
                    ),
                    use_container_width=True,
                    hide_index=False
                )
                
                # æŸ±çŠ¶å›¾
                st.subheader("ä¼°ç®—æ¶¨å¹…å¯¹æ¯”")
                chart_data = watched.set_index('åç§°')['ä¼°ç®—æ¶¨å¹…(%)']
                st.bar_chart(chart_data, height=400)
                
                # é¢å¤–ä¿¡æ¯
                st.caption(f"æœ€ååˆ·æ–°ï¼š{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
                
        except Exception as e:
            st.error(f"æ•°æ®è·å–å¤±è´¥ï¼š{str(e)}")
            st.info("å¸¸è§åŸå› ï¼šç½‘ç»œæ³¢åŠ¨ã€AKShare æ¥å£ä¸´æ—¶ä¸å¯ç”¨ã€ä»Šæ—¥éäº¤æ˜“æ—¥ã€‚è¯· 1-2 åˆ†é’Ÿåé‡è¯•ï¼Œæˆ–æ£€æŸ¥æ˜¯å¦å®‰è£…äº†æœ€æ–°ç‰ˆ akshareï¼ˆpip install akshare --upgradeï¼‰")

# ==================== é¡µè„š ====================
st.markdown("---")
st.markdown("""
**å…è´£å£°æ˜**ï¼šæœ¬å·¥å…·ä»…ç”¨äºä¸ªäººå­¦ä¹ å’Œå‚è€ƒï¼Œä¼°å€¼æ•°æ®æ¥æºäºç¬¬ä¸‰æ–¹ï¼ˆä¸œæ–¹è´¢å¯Œï¼‰ï¼Œå­˜åœ¨å»¶è¿Ÿæˆ–åå·®å¯èƒ½ï¼Œä¸ä¿è¯å‡†ç¡®æ€§ã€‚è¯·ä»¥å®˜æ–¹æ¸ é“å‡€å€¼å’Œå…¬å‘Šä¸ºå‡†ã€‚  
**æŠ€æœ¯æ ˆ**ï¼šStreamlit + AKShare  
**æ›´æ–°å»ºè®®**ï¼šæœ¬åœ°è¿è¡Œ `pip install --upgrade akshare streamlit pandas` ä¿æŒæœ€æ–°
""")
